#!/bin/sh

# Argument: $1 - installation folder

if [ ! -d "${1}/common" ] ; then
  echo "Not a Software AG installation! exitting"
  exit 1
fi

# Arguments:
# $1 - tanuki / server wrapper file
patchWrapper(){
  if [ ! -f ${1} ] ; then
    echo "No such file: ${1}"
    return 1
  fi
  echo "Verifying file ${1}"



  if grep -q "formatMsgNoLookups" "${1}" ; then
    echo "File ${1} is already patched..."
    return 2
  fi

  i=100

  while grep -q "wrapper.java.additional.${i}" "${1}" ; do
    i=$((i+1))
  done

  crtDate=`date +%y-%m-%dT%H.%M.%S_%3N`
  cp "${1}" "${1}.${crtDate}"

  echo "wrapper.java.additional.${i}=-Dlog4j2.formatMsgNoLookups=true" >> ${1}
}

find "${1}" -type f -name custom_wrapper.conf > /dev/shm/foundWrappers.txt
find "${1}" -type f -name Custom_Server_Common.conf >> /dev/shm/foundWrappers.txt


echo "Found wrappers:"
cat /dev/shm/foundWrappers.txt

while IFS= read -r wrapperFile
do
  echo "Processing $wrapperFile..."

  patchWrapper "$wrapperFile"
done < /dev/shm/foundWrappers.txt
